name: MyToDo Project Automation

on:
  issues:
    types: [opened, labeled]

jobs:
  setup_project_item:
    # ラベル「00_MyToDo」が付与された時のみ実行
    if: contains(github.event.issue.labels.*.name, '00_MyToDo')
    runs-on: ubuntu-latest
    steps:
      # 1. プロジェクトにIssueを追加してItemIDを取得
      - name: Add Issue to Project
        uses: actions/add-to-project@v1.0.1
        id: add_project
        with:
          project-url: https://github.com/users/${{ github.repository_owner }}/projects/1
          github-token: ${{ secrets.MY_PROJECT_PAT }}

      # 2. GraphQLでStatusをinboxにし、期限(Expired)を代入
      - name: Set Status and Expired Date
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.MY_PROJECT_PAT }}
          script: |
            const issueBody = context.payload.issue.body || "";
            // 本文から YYYY-MM-DD 形式の日付を抽出 (例: 2026-02-14)
            const dateMatch = issueBody.match(/\d{4}-\d{2}-\d{2}/);
            const expiredDate = dateMatch ? dateMatch[0] : null;

            const projectId = "PVT_kwHOBGaMN84BPBxJ";
            const itemId = "${{ steps.add_project.outputs.item-id }}";
            
            const statusFieldId = "PVTSSF_lAHOBGaMN84BPBxJzg9jq0U";
            const inboxOptionId = "ffcb7607";
            const expiredFieldId = "PVTF_lAHOBGaMN84BPBxJzg9rXts";

            const query = `
              mutation($project: ID!, $item: ID!, $status_field: ID!, $status_value: String!, $date_field: ID!, $date_value: Date) {
                updateStatus: updateProjectV2ItemFieldValue(input: {
                  projectId: $project, itemId: $item, fieldId: $status_field, value: { singleSelectOptionId: $status_value }
                }) { clientMutationId }
                
                ${expiredDate ? `updateDate: updateProjectV2ItemFieldValue(input: {
                  projectId: $project, itemId: $item, fieldId: $date_field, value: { date: $date_value }
                }) { clientMutationId }` : ''}
              }
            `;

            const variables = {
              project: projectId,
              item: itemId,
              status_field: statusFieldId,
              status_value: inboxOptionId,
              date_field: expiredFieldId,
              date_value: expiredDate
            };

            await github.graphql(query, variables);